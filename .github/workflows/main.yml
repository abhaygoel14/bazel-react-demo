name: Bazel Monorepo Build

on:
  push:
    branches: [main]
  pull_request:

jobs:
  bazel-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Restore Bazel cache
        uses: actions/cache@v4
        with:
          path: |
            .bazel-cache
            .bazel-repo-cache
          key: bazel-${{ runner.os }}-${{ hashFiles('**/BUILD.bazel', 'WORKSPACE', '.bazelrc') }}
          restore-keys: |
            bazel-${{ runner.os }}-

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # =========================
      # ZOMATO BUILD (with cache logs)
      # =========================
      - name: Build Zomato (cache debug)
        run: |
          echo "ðŸ”µ Building Zomato"
          bazel build //apps/zomato:zomato \
            --explain=zomato_explain.log \
            --verbose_explanations \
            --execution_log_json_file=zomato_exec.json

          echo "ðŸ“„ Zomato explain log (cache info):"
          grep -E "cached|reused|Executing" zomato_explain.log || true

      # =========================
      # SWIGGY BUILD (with cache logs)
      # =========================
      - name: Build Swiggy (cache debug)
        run: |
          echo "ðŸŸ¢ Building Swiggy"
          bazel build //apps/swiggy:swiggy \
            --explain=swiggy_explain.log \
            --verbose_explanations \
            --execution_log_json_file=swiggy_exec.json

          echo "ðŸ“„ Swiggy explain log (cache info):"
          grep -E "cached|reused|Executing" swiggy_explain.log || true
